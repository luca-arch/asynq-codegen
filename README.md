# asynq-codegen

This is a Go tool that generates boilerplate code for [hibiken/asynq](https://github.com/hibiken/asynq).

It scans your Go source files for `// asynq:` directives on structs and generates:

* strongly-typed task type constants
* task constructors
* processor adapters for `asynq.ServeMux`
* enqueue helper functions
* JSON helpers

This makes defining, enqueueing, and consuming Asynq tasks type-safe, discoverable, and boring, while still leaving a lot of flexibility to the user.

**Godoc comments are generated too**, this plays nicely with [pkgsite](https://pkg.go.dev/golang.org/x/pkgsite) and modern IDEs.

---

## License

This project is licensed under the **Apache License, Version 2.0**.

The licence applies to the **`asynq-codegen` tool itself**, not to the code it generates.

Code generated by `asynq-codegen` is not considered a derivative work and may be used under any terms.

---

## Installation

```bash
go install github.com/luca-arch/asynq-codegen@latest
```

Or run directly with:

```bash
go run github.com/luca-arch/asynq-codegen@latest
```

---

## Quick start

The quickest way to generate code is to annotate a struct with the `asynq:task` directive, and ensure the `//go:generate asynq-codegen` comment is in use (you need exactly one per package, not per file).

```go
package example

//go:generate asynq-codegen

// asynq:task
type SendEmail struct {
    To      string
    Subject string
	Body    string
}
```

Run `go generate ./...` to see a new file `asynq_generated.go` in the same package where the `asynq` annotations were found.

The generated file will contain, for instance:

```go
const TypeSendEmail = "example:send_email"

type SendEmailProcessor = func(context.Context, *SendEmail) error

type Processors struct {
    SendEmail SendEmailProcessor
}

func NewSendEmailProcessor(SendEmailProcessor) asynq.HandlerFunc { ... }

func NewSendEmailTask(*SendEmail) (*asynq.Task, error) { ... }

func EnqueueSendEmailContext(context.Context, *asynq.Client, *SendEmail, ...asynq.Option) (*asynq.Task, *asynq.TaskInfo, error) { ... }
```

See the generated files in [examples](./examples) folder.

---

## Generated API overview

### Enqueue a task

```go
client := asynq.NewClient(asynq.RedisClientOpt{Addr: redisAddr})
defer client.Close()

task, info, err := EnqueueSendEmailContext(ctx, client, &SendEmail{
    To:      "user@example.com",
    Subject: "Welcome user",
    Body:    "Hello!",
})
```

In the above example, `EnqueueSendEmailContext` accepts additional `asynq.Option` arguments to allow overriding the auto-generated ones. 

### Register task processors

```go
mux := asynq.NewServeMux()

processors := &Processors{
    SendEmail: func(_ context.Context, msg *SendEmail) error {
        log.Println("sending email to:", msg.To)

        return nil
    },
}

// Use Handle to register all non-nil handlers.
processors.Handle(mux)

// Or use HandleAll to get an error in the case a handler was forgotten.
if err := processors.HandleAll(mux); err != nil {
    log.Fatal(err)
}
```

### For more granular control

```go
mux := asynq.NewServeMux()

// This is what Handle and HandleAll do under the hood.
mux.HandleFunc(
    TypeSendEmail,
    NewSendEmailProcessor(func(_ context.Context, msg *SendEmail) error {
        log.Println("sending email to:", msg.To)
        
        return nil
    }),
)
```

---

## Supported directives

Directives are read from struct doc comments, and are all optional: only one `asynq:` directive is required for a struct to be processed.

### `asynq:task`

```
// asynq:task send_email
```

This directive marks a struct as an Asynq task and controls the generated task name.

If no value is provided, the struct name is converted to snake case.

### `asynq:retry`

```
// asynq:retry 3
```

Directive for [asynq.MaxRetry](https://github.com/hibiken/asynq/wiki/Task-Retry), defaults to **5 attempts**.

### `asynq:timeout`

```
// asynq:timeout 5m
```

Directive for [asynq.Timeout](https://github.com/hibiken/asynq/wiki/Task-Timeout-and-Cancelation), defaults to **1 minute**.

---

## Contributing

Issues and pull requests are welcome.

If you plan to add new directives or larger changes, please open an issue first
to discuss the design.

### Local development notes

- Lint files with `golangci-lint run --fix ./...`
- Generate example files with `go generate ./...` 
- Use [gitmoji](https://gitmoji.dev/)!

---

## TODOs

1. [ ] Reject unknown `asynq:` directives instead of silently discarding them
2. [ ] Fix `SA1019: ast.Package has been deprecated since Go 1.22`
3. [ ] Add more `asynq:` directives
